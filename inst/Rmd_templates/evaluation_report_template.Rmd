---
title: "Evaluation report for `r params$code`/`r params$model`/`r params$conf`"
author: "Victor Granda / Miquel De CÃ¡ceres"
date: "`r Sys.time()`"
params:
  wd: '/home/miquel/OneDrive/Professional/Recerca/MedfateValidation/'
  code: 'FRAPUE'
  model: 'spwb'
  conf: 'basic'
output:
  html_document:
    df_print: paged
    toc: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(error = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_knit$set(root.dir = params$wd)

# libraries
library(medfate)
library(medfatereports)
library(dplyr)
library(ggplot2)
library(gridExtra)
library(cowplot)
```

```{r data, message=FALSE, warning=FALSE}

control <- yaml::yaml.load_file(system.file("yaml_configurations", paste0(params$conf, ".yaml"),
                                          package = "medfatereports"))

site_data <- load_list(params$code)

eval_REW <- "SWC" %in% names(site_data$measuredData)
```

# General Info

```{r gen_info}
data.frame(
    Pkg_version  = as.character(packageVersion('medfate')),
    Site = params$code,
    Model = params$model,
    Configuration = params$conf,
    Date = format(Sys.Date())
  )
```

## Remarks

```{r remarks, max.print=10}
site_data$remarks
```


# Run Model

```{r simple_model, eval=TRUE, message=FALSE}
soil_object <- soil(site_data$soilData, VG_PTF = "Toth")

if(params$model=="spwb") {
  input_object <- medfate::forest2spwbInput(site_data$forest_object1, 
                                            soil_object, 
                                            site_data$sp_params, 
                                            control)
  input_object <- modifyCohortParams(input_object, site_data$customParams)
  res <- spwb(input_object,
              site_data$meteoData, 
              latitude = site_data$terrainData$latitude, 
              elevation = site_data$terrainData$elevation, 
              slope = site_data$terrainData$slope, 
              aspect = site_data$terrainData$aspect)
} else if(params$model=="growth") {
  input_object <- medfate::forest2growthInput(site_data$forest_object1, 
                                            soil_object, 
                                            site_data$sp_params, 
                                            control)
  input_object <- modifyCohortParams(input_object, site_data$customParams)
  res <- growth(input_object,
              site_data$meteoData, 
              latitude = site_data$terrainData$latitude, 
              elevation = site_data$terrainData$elevation, 
              slope = site_data$terrainData$slope, 
              aspect = site_data$terrainData$aspect)
}
```


```{r}
# saving result
file_name <- file.path(file.path('Output', packageVersion('medfate')[[1]],
                                 params$model, params$conf, params$code),
                       paste0('simulation_result.rds'))
file_name
saveRDS(res, file = file_name)
```
# Output plots

## PET & precipitation
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
    plot(res, type="PET_Precipitation")
```



## Evapotranspiration
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
    plot(res, type="Evapotranspiration")
```

## Soil moisture content
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
    plot(res, type="SoilTheta")
```

## Plant LAI
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
     plot(res, type = 'PlantLAI', bySpecies = TRUE)
```

## Plant stress
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
     plot(res, type = 'PlantStress', bySpecies = TRUE)
```

## Transpiration per leaf
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
     plot(res, type = 'TranspirationPerLeaf', bySpecies = TRUE)
```

## Gross photosynthesis per leaf
```{r eval = params$model=="spwb", fig.height=6, fig.width=8}
     plot(res, type = 'GrossPhotosynthesisPerLeaf', bySpecies = TRUE)
```

# Evaluation

## Soil moisture
```{r eval = eval_REW}
medfate::evaluation_stats(res, site_data$measuredData, type="REW")
```


```{r eval = eval_REW, fig.height=6, fig.width=8}
g1<-medfate::evaluation_plot(res, site_data$measuredData, type="REW")+
  theme(legend.position = c(0.2,0.9), legend.background = element_blank())
g1
```

```{r eval = eval_REW, fig.height=6, fig.width=8}
g2<-medfate::evaluation_plot(res, site_data$measuredData, type="REW", plotType = "scatter")
g2
```

# Input object

```{r input, collapse=FALSE}
  print(input_object)
```


# Session Info

```{r session_info}
# printing session info
devtools::session_info()
```

